name: Workflow Time Report
decription: Workflow Time Report
inputs:
  create-issue:
    description: Whether to create ISSUE and LABEL
    required: true
    default: 'true'
outputs:
  markdown:
    description: Markdown Report
    value: ${{ steps.markdown.outputs.stdout }}

runs:
  using: composite
  steps:
    - name: Get current time
      id: current_time
      shell: bash
      run: echo "::set-output name=stdout::$(date '+%Y-%m-%d %H:%M:%S')"
      env:
        TZ: Asia/Tokyo
        GH_TOKEN: ${{ github.token }}

    - name: Generate markdown text
      id: markdown
      shell: bash
      run: |
        data=$(bash $GITHUB_ACTION_PATH/report.sh "${{ github.repository }}")
        data="${data//$'\n'/\\n}"
        echo "::set-output name=stdout::$data"
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Create issue and label
      shell: bash
      if: ${{ inputs.create-issue == 'true' }}
      run: |
        label_name='workflow-time-report'
        gh label create "$label_name" -R ${{ github.repository }} --description "workflow time report" --color 000000 -f
        body="${{ steps.markdown.outputs.stdout }}"
        gh issue create -R ${{ github.repository }} --label "$label_name" --body "$(echo -e $body)" --title "Workflow Time Report（${{ steps.current_time.outputs.stdout }}）"
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Create PR for timeout-minutes
      shell: bash
      run: |
        ls .
        # python -c "import yaml; import json; import sys; print(json.dumps(yaml.load(sys.stdin, Loader=yaml.FullLoader), indent=2))
